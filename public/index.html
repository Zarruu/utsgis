<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place CRUD with Leaflet</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* (CSS Anda dari sebelumnya tetap sama, tidak perlu diubah) */
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; }
        h1, h2 { text-align: center; color: #444; }
        form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd; }
        button { width: 100%; padding: 10px; border: none; background-color: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 16px; }
        ul { list-style: none; padding: 0; }
        li { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .actions button { width: auto; padding: 5px 10px; margin-left: 5px; font-size: 12px; }
        .edit-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        #map { height: 400px; width: 100%; background-color: #eee; margin-bottom: 20px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Manajemen Tempat</h1>
    <form id="place-form">
        <div id="map"></div>
        <p style="text-align:center; font-style:italic; color:#666; margin-top:-10px; margin-bottom:15px;">Klik di peta untuk memilih lokasi</p>
        <input type="hidden" id="place-id">
        <input type="text" id="name" placeholder="Nama Tempat" required>
        <input type="number" id="longitude" placeholder="Longitude" step="any" required readonly>
        <input type="number" id="latitude" placeholder="Latitude" step="any" required readonly>
        <button type="submit">Simpan</button>
    </form>
    <h2>Daftar Tempat</h2>
    <ul id="places-list"></ul>
</div>

<script>
    const apiUrl = 'http://localhost:8080/api/places';
    const form = document.getElementById('place-form');
    const placeIdInput = document.getElementById('place-id');
    const nameInput = document.getElementById('name');
    const longInput = document.getElementById('longitude');
    const latInput = document.getElementById('latitude');
    const placesList = document.getElementById('places-list');

    // --- INISIALISASI PETA LEAFLET ---
    const bandungCoords = [-6.9175, 107.6191]; // Format Leaflet: [latitude, longitude]
    const map = L.map('map').setView(bandungCoords, 13);
    let marker = L.marker(bandungCoords).addTo(map);

    // Menambahkan "tile layer" dari OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Event listener saat peta diklik
    map.on('click', function(e) {
        const coords = e.latlng;
        marker.setLatLng(coords);
        updateFormFields(coords);
    });

    function updateFormFields(coords) {
        latInput.value = coords.lat;
        longInput.value = coords.lng;
    }

    // --- FUNGSI & EVENT LISTENER LAINNYA (TETAP SAMA) ---
    async function fetchPlaces() {
        const response = await fetch(apiUrl);
        const places = await response.json();
        
        placesList.innerHTML = '';
        if (!places) return;

        places.forEach(place => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${place.name}</span>
                <div class="actions">
                    <button class="edit-btn" data-id="${place.id}" data-name="${place.name}" data-long="${place.location.coordinates[0]}" data-lat="${place.location.coordinates[1]}">Edit</button>
                    <button class="delete-btn" data-id="${place.id}">Hapus</button>
                </div>
            `;
            placesList.appendChild(li);
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = placeIdInput.value;
        const name = nameInput.value;
        const long = parseFloat(longInput.value);
        const lat = parseFloat(latInput.value);

        const url = id ? `${apiUrl}/${id}` : apiUrl;
        const method = id ? 'PUT' : 'POST';

        await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                location: {
                    type: "Point",
                    coordinates: [long, lat]
                }
            })
        });

        form.reset();
        placeIdInput.value = '';
        fetchPlaces();
    });

    placesList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const { id, name, long, lat } = e.target.dataset;
            placeIdInput.value = id;
            nameInput.value = name;
            longInput.value = long;
            latInput.value = lat;

            const coords = [lat, long];
            map.setView(coords, 15); // Pindahkan view peta
            marker.setLatLng(coords); // Pindahkan marker
            
            window.scrollTo(0, 0); 
        }

        if (e.target.classList.contains('delete-btn')) {
            const id = e.target.dataset.id;
            if (confirm('Apakah Anda yakin ingin menghapus tempat ini?')) {
                await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
                fetchPlaces();
            }
        }
    });

    // Panggil fetchPlaces saat halaman dimuat
    fetchPlaces();
</script>

</body>
</html>